# class_weights 實驗完整比較報告

## 實驗概述

- **實驗目的**：找出最佳類別權重 (class_weights) 設定
- **基準版本**：v6 (SupCon=0.10, seq_len=5, class_weights=[1.0, 1.3, 1.0])
- **測試範圍**：5 種不同的類別權重組合
- **固定參數**：
  - SupCon 權重：0.10
  - seq_len：5
  - Direction Loss 權重：1.0
  - Magnitude Loss 權重：0.1

### 類別權重說明

```
class_weights = [下跌權重, 持平權重, 上漲權重]
```

- 權重越高：模型越重視該類別的預測準確度
- 權重越低：模型越傾向忽略該類別

---

## 📊 整體指標比較

| 版本 | class_weights | 整體準確率 | F1 Score | Silhouette |
|------|---------------|-----------|----------|------------|
| v6 (基準) | [1.0, 1.3, 1.0] | 36.07% | 0.3400 | -0.0144 |
| cw_100 | [1.0, 1.0, 1.0] | 34.61% | - | -0.0080 |
| cw_120 | [1.2, 0.9, 1.2] | 36.69% | 0.3669 | -0.0106 |
| cw_130 | [1.3, 0.8, 1.3] | 35.66% | 0.3495 | -0.0108 |
| **cw_150** | **[1.5, 0.7, 1.5]** | **38.55%** ✅ | - | **-0.0073** ✅ |

---

## 📈 各類別準確率比較

| 版本 | class_weights | 下跌 | 持平 | 上漲 |
|------|---------------|------|------|------|
| v6 | [1.0, 1.3, 1.0] | 32.38% | **65.39%** | 18.90% |
| cw_100 | [1.0, 1.0, 1.0] | 29.61% | 48.26% | 28.15% |
| cw_120 | [1.2, 0.9, 1.2] | 33.20% | 37.91% | 38.87% |
| cw_130 | [1.3, 0.8, 1.3] | **47.25%** ✅ | 20.87% | 35.87% |
| cw_150 | [1.5, 0.7, 1.5] | 39.31% | 18.32% | **51.94%** ✅ |

---

## 📉 預測分布比較

| 版本 | class_weights | 下跌預測 | 下跌真實 | 持平預測 | 持平真實 | 上漲預測 | 上漲真實 |
|------|---------------|---------|---------|---------|---------|---------|---------|
| v6 | [1.0, 1.3, 1.0] | 404 | 491 | 802 | 393 | 244 | 566 |
| cw_100 | [1.0, 1.0, 1.0] | 254 | 304 | 450 | 288 | 261 | 373 |
| **cw_120** | **[1.2, 0.9, 1.2]** | **448** | **491** | **448** | **393** | **554** | **566** |
| cw_130 | [1.3, 0.8, 1.3] | 689 | 491 | 251 | 393 | 510 | 566 |
| cw_150 | [1.5, 0.7, 1.5] | 549 | 491 | 184 | 393 | 717 | 566 |

### 持平偏向倍數（預測/真實）

| 版本 | class_weights | 持平偏向倍數 | 評估 |
|------|---------------|-------------|------|
| v6 | [1.0, 1.3, 1.0] | 2.04x | ❌ 嚴重偏向持平 |
| cw_100 | [1.0, 1.0, 1.0] | 1.56x | ⚠️ 偏向持平 |
| **cw_120** | **[1.2, 0.9, 1.2]** | **1.14x** | **✅ 最平衡** |
| cw_130 | [1.3, 0.8, 1.3] | ~0.8x | ⚠️ 略偏向漲跌 |
| cw_150 | [1.5, 0.7, 1.5] | 0.47x | ❌ 嚴重偏向漲跌 |

---

## 📊 趨勢分析圖

### 持平權重 vs 各指標

```
持平權重:   1.3      1.0      0.9      0.8      0.7
版本:       v6     cw_100   cw_120   cw_130   cw_150
            ↓        ↓        ↓        ↓        ↓
整體準確:  36.1%    34.6%    36.7%    35.7%    38.6% ✅
持平準確:  65.4%    48.3%    37.9%    20.9%    18.3%  ← 持續下降
上漲準確:  18.9%    28.2%    38.9%    35.9%    51.9% ✅ ← 持續上升
下跌準確:  32.4%    29.6%    33.2%    47.3%    39.3%
```

### 效能曲線

```
整體準確率
  39% |                              ★ cw_150
  38% |
  37% |              ★ cw_120
  36% |  ● v6                 ● cw_130
  35% |        ● cw_100
      +----------------------------------------
         1.3    1.0    0.9    0.8    0.7   持平權重
```

```
上漲準確率
  52% |                              ★ cw_150
  45% |
  38% |              ★ cw_120  ● cw_130
  30% |        ● cw_100
  20% |  ● v6
      +----------------------------------------
         1.3    1.0    0.9    0.8    0.7   持平權重
```

---

## 🔍 關鍵發現

### 1. 持平權重與預測行為的關係

| 持平權重 | 模型行為 |
|---------|---------|
| 1.3 (高) | 傾向預測持平，保守策略 |
| 1.0 (中) | 較平衡，但仍偏向持平 |
| 0.9 | 最佳平衡點 |
| 0.8 | 開始偏向漲跌預測 |
| 0.7 (低) | 大量預測漲跌，激進策略 |

### 2. 整體準確率 vs 預測平衡度的權衡

- **cw_150** 達到最高整體準確率 (38.55%)，但預測分布極度偏向漲跌
- **cw_120** 整體準確率次高 (36.69%)，且預測分布最平衡
- 這是「準確率」vs「穩定性」的權衡

### 3. 交易風險分析

| 版本 | 過度交易風險 | 說明 |
|------|-------------|------|
| v6 | 低 | 常預測持平，減少交易次數 |
| cw_120 | 中 | 平衡的交易頻率 |
| cw_150 | **高** | 很少預測持平，頻繁交易 |

---

## 🏆 各目標最佳版本

| 目標 | 最佳版本 | 數值 |
|------|---------|------|
| **最高整體準確率** | cw_150 [1.5, 0.7, 1.5] | 38.55% |
| **最平衡預測分布** | cw_120 [1.2, 0.9, 1.2] | 偏向倍數 1.14x |
| **最高上漲準確率** | cw_150 [1.5, 0.7, 1.5] | 51.94% |
| **最高下跌準確率** | cw_130 [1.3, 0.8, 1.3] | 47.25% |
| **最高持平準確率** | v6 [1.0, 1.3, 1.0] | 65.39% |
| **最佳 Silhouette** | cw_150 [1.5, 0.7, 1.5] | -0.0073 |

---

## 🎯 最終推薦

### 根據交易風格選擇

| 交易風格 | 推薦版本 | class_weights | 理由 |
|---------|---------|---------------|------|
| **積極交易** | cw_150 | [1.5, 0.7, 1.5] | 最高準確率，漲跌預測強，但交易頻繁 |
| **穩健交易** | **cw_120** ✅ | **[1.2, 0.9, 1.2]** | **預測最平衡，風險可控** |
| **保守交易** | v6 | [1.0, 1.3, 1.0] | 持平準確率高，減少錯誤交易 |

### 我的最終推薦：cw_120 [1.2, 0.9, 1.2]

**理由**：

1. ✅ 整體準確率 36.69%（僅次於 cw_150）
2. ✅ 預測分布最平衡（448/448/554 vs 真實 491/393/566）
3. ✅ 持平準確率 37.91%（可接受的水平，不會過度交易）
4. ✅ 上漲準確率 38.87%（大幅優於 v6 的 18.90%）
5. ✅ 下跌準確率 33.20%（略優於 v6）
6. ✅ **風險可控，適合實盤交易**

---

## 📋 最佳設定總結

### 推薦設定（cw_120）

```python
# DataConfig
seq_len = 5

# LossWeights  
supcon_weight = 0.10
dir_weight = 1.0
mag_weight = 0.1

# MultiTaskLoss 中的 class_weights
class_weights = [1.2, 0.9, 1.2]  # [下跌, 持平, 上漲]
```

### 預期表現

| 指標 | 數值 |
|------|------|
| 整體準確率 | 36.69% |
| F1 Score | 0.3669 |
| 下跌準確率 | 33.20% |
| 持平準確率 | 37.91% |
| 上漲準確率 | 38.87% |
| Silhouette | -0.0106 |

---

## 📁 相關檔案

| 檔案 | class_weights | 說明 |
|------|---------------|------|
| `4C_DAY_SupCon_修正版.py` | [1.0, 1.3, 1.0] | v6 基準版本 |
| `4C_v6_cw_100.py` | [1.0, 1.0, 1.0] | 無權重版本 |
| `4C_v6_cw_120.py` | [1.2, 0.9, 1.2] | ✅ 推薦版本 |
| `4C_v6_cw_130.py` | [1.3, 0.8, 1.3] | 中間測試版本 |
| `4C_v6_cw_150.py` | [1.5, 0.7, 1.5] | 最高準確率版本 |

---

## 🔄 與其他實驗的整合

### 完整最佳參數組合

結合 SupCon 權重實驗和 seq_len 實驗的結果：

| 參數 | 最佳值 | 來源實驗 |
|------|--------|---------|
| SupCon 權重 | 0.10 | SupCon 權重實驗 |
| seq_len | 5 | seq_len 實驗 |
| class_weights | [1.2, 0.9, 1.2] | class_weights 實驗 |

### 下一步

使用上述最佳參數組合，進入 **PPO2 強化學習階段**。

---

*報告生成日期：2024.12.13*
